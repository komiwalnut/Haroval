name: Supabase Health Ping

on:
  schedule:
    # Run 3 times per day (every 8 hours) to ensure consistent activity
    - cron: "0 0 * * *"   # Midnight UTC
    - cron: "0 8 * * *"   # 8 AM UTC
    - cron: "0 16 * * *"  # 4 PM UTC
  workflow_dispatch:

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Verify Supabase Activity
        env:
          SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "‚ùå Missing required secrets. Please set NEXT_PUBLIC_SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY."
            exit 1
          fi

          echo "üîÑ Starting Supabase health check at $(date -u +"%Y-%m-%dT%H:%M:%SZ")..."
          
          # Helper function to check if HTTP code is 2xx (success)
          is_success() {
            local code=$1
            [ "$code" -ge 200 ] && [ "$code" -lt 300 ]
          }
          
          # Test 1: Query users table (count check)
          echo "üìä Testing users table..."
          USERS_RESPONSE=$(curl --silent --show-error \
            "$SUPABASE_URL/rest/v1/users?select=id&limit=1" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            -H "Prefer: count=exact" \
            -w "\n%{http_code}")
          
          USERS_HTTP_CODE=$(echo "$USERS_RESPONSE" | tail -n1)
          if ! is_success "$USERS_HTTP_CODE"; then
            echo "‚ùå Users table query failed with HTTP $USERS_HTTP_CODE"
            exit 1
          fi
          echo "‚úÖ Users table accessible (HTTP $USERS_HTTP_CODE)"
          
          # Test 2: Query decks table
          echo "üìä Testing decks table..."
          DECKS_RESPONSE=$(curl --silent --show-error \
            "$SUPABASE_URL/rest/v1/decks?select=id,title&limit=1" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            -H "Prefer: count=exact" \
            -w "\n%{http_code}")
          
          DECKS_HTTP_CODE=$(echo "$DECKS_RESPONSE" | tail -n1)
          if ! is_success "$DECKS_HTTP_CODE"; then
            echo "‚ùå Decks table query failed with HTTP $DECKS_HTTP_CODE"
            exit 1
          fi
          echo "‚úÖ Decks table accessible (HTTP $DECKS_HTTP_CODE)"
          
          # Test 3: Query flashcards table
          echo "üìä Testing flashcards table..."
          FLASHCARDS_RESPONSE=$(curl --silent --show-error \
            "$SUPABASE_URL/rest/v1/flashcards?select=id&limit=1" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            -H "Prefer: count=exact" \
            -w "\n%{http_code}")
          
          FLASHCARDS_HTTP_CODE=$(echo "$FLASHCARDS_RESPONSE" | tail -n1)
          if ! is_success "$FLASHCARDS_HTTP_CODE"; then
            echo "‚ùå Flashcards table query failed with HTTP $FLASHCARDS_HTTP_CODE"
            exit 1
          fi
          echo "‚úÖ Flashcards table accessible (HTTP $FLASHCARDS_HTTP_CODE)"
          
          echo ""
          echo "‚úÖ All health checks passed!"
          echo "üéâ Supabase is active and responsive at $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          echo "üìà Database activity verified across users, decks, and flashcards tables"

